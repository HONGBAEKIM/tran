{% extends 'main/base.html' %}
{% load static %}

{% block title %}Pong Game{% endblock %}

{% block content %}
<style>
    canvas {
        display: block;
        margin: auto;
        background: #000;
    }

    body {
        background: url("{% static 'images/pong.png' %}") no-repeat center center fixed;
        background-size: cover;
    }
    .content {
        background-color: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 10px;
        margin-top: 50px;
    }
</style>

<div id="gameModeSelection" style="text-align:center; margin-bottom:20px;">
    {% if is_logged_in %}
        <button type="button" class="btn btn-warning" onclick="selectGameMode('user-vs-computer')">User vs Computer</button>
        <button type="button" class="btn btn-warning" onclick="selectGameMode('user-vs-user')">User vs User</button>
        <button type="button" class="btn btn-warning" onclick="selectGameMode('remoteuser-vs-remoteuser')">remoteuser vs remoteuser</button>

    {% else %}
        <button type="button" class="btn btn-warning" onclick="selectGameMode('user-vs-computer')">Play against computer</button>
        <button type="button" class="btn btn-warning" onclick="selectGameMode('user-vs-user')">Play against friend</button>
        <button type="button" class="btn btn-warning" onclick="selectGameMode('remoteuser-vs-remoteuser')">Play remote </button>
    {% endif %}
</div>

<div id="nameInputs" style="display:none;">
    {% if is_logged_in %}
        <p>Player 1: {{ user.username }}</p>
    {% else %}
        <p>Player 1: Guest</p>
    {% endif %}
    <input type="text" id="player2Name" class="name-input" placeholder="Player 2 Name">
    <button type="button" class="btn btn-primary" onclick="startGameWithPlayer2()">Start Game</button>
</div>

<div id="gameButtons" style="display:none;">
    <button type="button" class="btn btn-danger" onclick="endGame()">End Game</button>
</div>

<canvas id="pongCanvas" width="600" height="400" style="display:none;"></canvas>

<script>
    // function selectGameMode(mode) {
    //     if (mode === 'user-vs-user') {
    //         document.getElementById('gameModeSelection').style.display = 'none';
    //         document.getElementById('nameInputs').style.display = 'block';
    //     } else if (mode === 'remoteuser-vs-remoteuser') {
    //         // document.getElementById('gameModeSelection').style.display = 'none';
    //         // Assuming you have gameId and sessionToken available to join a remote game
    //         const gameId = prompt('Enter Game ID:');
    //         const sessionToken = prompt('Enter Session Token:');
    //         joinRemoteGame(gameId, sessionToken);
    //         // startRemoteGame('Player 1', 'Player 2', mode); // Adjust player names as needed
    //         // document.getElementById('nameInputs').style.display = 'block'; // Display name input for Player 1
    //     } else {
    //         document.getElementById('gameModeSelection').style.display = 'none';
    //         startGame('Guest', 'Computer', 'user-vs-computer');
    //     }
    // }

    function selectGameMode(mode) {
        if (mode === 'user-vs-user') {
            document.getElementById('gameModeSelection').style.display = 'none';
            document.getElementById('nameInputs').style.display = 'block';
        } else if (mode === 'remoteuser-vs-remoteuser') {
            document.getElementById('gameModeSelection').style.display = 'none';

            // Fetch CSRF token and start remote game
            getCsrfToken().then(csrfToken => {
                fetch('/api/game/start-remote/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // Include CSRF token in headers
                    },
                    body: JSON.stringify({ player1Name: 'Player 1', player2Name: 'Player 2' })
                })
                .then(response => response.json())
                .then(data => {
                    // Check if the response contains gameId and sessionToken
                    if (data.success) {
                        const gameId = data.gameId; // Assuming your API returns gameId and sessionToken
                        const sessionToken = data.sessionToken;
                        joinRemoteGame(gameId, sessionToken);
                    } else {
                        alert('Failed to start remote game');
                        document.getElementById('gameModeSelection').style.display = 'block'; // Show game mode selection again
                    }
                })
                .catch(error => {
                    console.error('Error starting remote game:', error);
                    document.getElementById('gameModeSelection').style.display = 'block'; // Show game mode selection again
                });
            });

            // Optionally, you can show name input for Player 1 here
            // document.getElementById('nameInputs').style.display = 'block';
        } else {
            document.getElementById('gameModeSelection').style.display = 'none';
            startGame('Guest', 'Computer', 'user-vs-computer');
        }
    }


    function startGameWithPlayer2() {
        const player2Name = document.getElementById('player2Name').value;
        if (player2Name.trim() === '') {
            alert('Please enter a valid name for Player 2');
        } else {
            const player1Name = '{{ user.username|default:"Guest" }}';
            startGame(player1Name, player2Name, 'user-vs-user');
        }
    }

    function startGame(player1Name, player2Name, mode) {
        document.getElementById('nameInputs').style.display = 'none';
        document.getElementById('gameButtons').style.display = 'block';
        document.getElementById('pongCanvas').style.display = 'block';
        initializeGame(player1Name, player2Name, mode);
    }

    function endGame() {
        var redirecturi = "/";
        window.location.href = redirecturi;
    }
</script>

<script src="{% static 'js/pong.js' %}"></script>
{% endblock %}
